<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Loger">

	<resultMap type="Calculate" id="calculateResultSet">
		<id property="calNo" column="CAL_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="chNo" column="CH_NO" />
		<result property="calSTDT" column="CAL_STDT" />
		<result property="calEDT" column="CAL_EDT" />
		<result property="calPrice" column="CAL_PRICE" />
		<result property="amountPrice" column="AMOUNT_PRICE" />
		<result property="calVAT" column="CAL_VAT" />
		<result property="calTY" column="CAL_TY" />
		<result property="accNm" column="ACC_NM" />
		<result property="bankNm" column="BANK_NM" />
		<result property="account" column="ACCOUNT" />
		<result property="nNo" column="RANK" />
	</resultMap>

	<resultMap type="Loger" id="logerResultSet">
		<id property="chNo" column="CH_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="chNm" column="CH_NM" />
		<result property="vNo" column="V_NO" />
		<result property="chDT" column="CH_DT" />
		<result property="chInfo" column="CH_INFO" />
		<result property="accNm" column="ACC_NM" />
		<result property="bankNm" column="BANK_NM" />
		<result property="account" column="ACCOUNT" />
		<result property="subNum" column="SUBNUM" />
		<result property="status" column="STATUS" />
	</resultMap>

	<resultMap type="Support" id="supportResultSet">
		<id property="supNo" column="SUP_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="chNo" column="CH_NO" />
		<result property="supSTDT" column="SUP_STDT" />
		<result property="supPrice" column="SUP_PRICE" />
		<result property="supTY" column="SUP_TY" />
		<result property="nNo" column="RANK" />
		<result property="nickname" column="NICKNAME" />
		<result property="regEDT" column="REG_EDT" />
		<result property="regStatus" column="REG_STATUS" />
		<result property="calStatus" column="CAL_STATUS" />
	</resultMap>

	<resultMap type="Loger2" id="logerResultSet2">
		<id property="chNo" column="CH_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="chNm" column="CH_NM" />
		<result property="vNo" column="V_NO" />
		<result property="chDT" column="CH_DT" />
		<result property="chInfo" column="CH_INFO" />
		<result property="subNum" column="SUBNUM" />
		<result property="status" column="STATUS" />
		<result property="amNo" column="AM_NO" />
		<result property="fileNm" column="FILE_NM" />	
		<result property="amDt" column="AM_DT" />
		<result property="amTY" column="AM_TY" />
	</resultMap>

	<resultMap type="Report" id="ReportResultSet">
		<id property="reno" column="RE_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="chNm" column="CH_NM" />
		<result property="retarget" column="RE_TARGET" />
		<result property="redt" column="RE_DT" />
		<result property="rewhy" column="RE_WHY" />
		<result property="rety" column="RE_TY" />
		<result property="vNo" column="V_NO" />
		<result property="repno" column="REP_NO" />
		<result property="vTitle" column="V_TITLE" />
		<result property="vcount" column="COUNT" />
		<result property="recount" column="RE_COUNT" />
		<result property="ccount" column="C_COUNT" />
		<result property="fileNm" column="FILE_NM" />
		<result property="uploadDt" column="UPLOAD_DT" />
		
	</resultMap>
	<resultMap type="Report" id="Report2ResultSet">
		<id property="reno" column="RE_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="chNm" column="CH_NM" />
		<result property="retarget" column="RE_TARGET" />
		<result property="redt" column="RE_DT" />
		<result property="rewhy" column="RE_WHY" />
		<result property="rety" column="RE_TY" />
		<result property="repno" column="REP_NO" />
		<result property="vcount" column="COUNT" />
		<result property="recount" column="RE_COUNT" />
		<result property="ccount" column="C_COUNT" />
	</resultMap>

	<resultMap type="Video" id="VideoResultSet">
		<id property="vNo" column="V_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="vTitle" column="V_TITLE" />
		<result property="count" column="COUNT" />
		<result property="chNm" column="CH_NM" />
		<result property="tag" column="TAG" />
		<result property="vblYn" column="VBL_YN" />
		<result property="uploadDt" column="UPLOAD_DT" />
		<result property="modifyDt" column="MODIFY_DT" />
		<result property="adultAut" column="ADULT_AUT" />
		<result property="adYn" column="AD_YN" />
		<result property="adInfo" column="AD_INFO" />
		<result property="location" column="LOCATION" />
		<result property="info" column="INFO" />
		<result property="fileNm" column="FILE_NM" />
		<result property="openTy" column="OPEN_TY" />
		<result property="nNo" column="RANK" />
		<result property="afileNm" column="AFILE_NM" />
		<result property="apNm" column="AP_NM" />
		<result property="apAd" column="AP_AD" />
	</resultMap>
	
	
	<resultMap type="SubUserInfo" id="SubUserInfoResultSet">
		<id property="chNo" column="CH_NO" />
		<result property="nickname" column="NICKNAME" />
		<result property="chNm" column="CH_NM" />
		<result property="userNo" column="USER_NO" />
	
		
	</resultMap>
	<resultMap type="AddVideo" id="addVideoResultSet">
		<id property="aNo" column="A_NO" />
		<result property="vNo" column="V_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="addCt" column="ADD_CT" />
		<result property="uploadDt" column="UPLOAD_DT" />
		<result property="modifyDt" column="MODIFY_DT" />
		<result property="apNo" column="AP_NO" />
		<result property="vNo" column="V_NO" />
		<result property="userNo" column="USER_NO" />
		<result property="apXY" column="AP_XY" />
		<result property="apNm" column="AP_NM" />
		<result property="apAd" column="AP_AD" />
	</resultMap>
	
	<resultMap type="Attachment" id="AttachmentResultSet">
		<id property="userNo" column="USER_NO" />
		<result property="amNo" column="AM_NO" />
		<result property="fileNm" column="FILE_NM" />
		<result property="amDt" column="AM_DT" />
		<result property="enrollNm" column="ENROLL_NM" />
		<result property="modifyNm" column="MODIFY_NM" />
		<result property="amTY" column="AM_TY" />
	</resultMap>
	
	<!-- 로거 동영상 장소 삭제  -->
	<delete id="delectAddplace" parameterType="int">
		DELETE FROM ADDPLACE
		WHERE V_NO = #{vNo}
		AND AP_NM = #{apNm}
		AND AP_AD = #{apAd}
	</delete>
	
	<!-- 로거 동영상 수정 기본 정보 페이지 출력 -->
	<select id="selectLogerVideo" resultMap="VideoResultSet">
	SELECT RANK, AFILE_NM, V_NO, USER_NO, V_TITLE, COUNT, CH_NM, TAG, VBL_YN, UPLOAD_DT, MODIFY_DT, 
        ADULT_AUT, AD_YN, AD_INFO, LOCATION, INFO, FILE_NM, OPEN_TY, AP_NM, AP_AD
		FROM (SELECT ROW_NUMBER() OVER(ORDER BY V.UPLOAD_DT DESC) RANK,	V.*, A.FILE_NM AFILE_NM, AP.AP_NM, AP.AP_AD
		FROM VIDEO V
		JOIN MEMBER M ON(V.USER_NO = M.USER_NO)
		JOIN ATTACHMENT A ON(V.V_NO = A.V_NO)
        LEFT OUTER JOIN ADDPLACE AP ON(V.V_NO = AP.V_NO)
		WHERE V.V_NO = #{vNo})
		ORDER BY RANK ASC
	</select>
	
	<!-- 로거 동영상 수정 추가 정보 페이지 출력 -->
	<select id="selectLogerAddVideo" resultMap="addVideoResultSet">
	SELECT RANK, A_NO, V_NO, USER_NO, ADD_CT, UPLOAD_DT, MODIFY_DT, AP_NO, AP_XY, AP_NM, AP_AD
		FROM (SELECT ROW_NUMBER() OVER(ORDER BY AI.UPLOAD_DT DESC) RANK,
		A_NO, AI.V_NO, AI.USER_NO, ADD_CT, AI.UPLOAD_DT, AI.MODIFY_DT, AP_NO, AP_XY, AP_NM, AP_AD
		FROM ADDINFO AI
		JOIN MEMBER M ON(AI.USER_NO = M.USER_NO)
		JOIN ADDPLACE AP ON(AI.USER_NO = AP.USER_NO)
		JOIN VIDEO V ON(AI.V_NO = V.V_NO)
		WHERE V.V_NO = #{vNo})
		ORDER BY RANK ASC
	</select>
	
	<!-- 로거 동영상 수정 update -->
	<update id="updateLogerVideo" parameterType="Loger">
		UPDATE VIDEO SET V_TITLE = #{vTitle}, TAG = #{tag}, OPEN_TY = #{openTy}, ADULT_AUT = #{adultAut},
		AD_YN = #{adYn}, AD_INFO = #{adInfo}
		WHERE V_NO = #{vNo}
	</update>
	
	<!-- 로거 동영상 썸네일 수정 update -->
	<update id="updateLogerAttachment" parameterType="Attachment">
		UPDATE ATTACHMENT SET FILE_NM = #{fileNm}
		WHERE V_NO = #{vNo}
        AND USER_NO = #{userNo}
	</update>
	
	
	<!-- 로거 동영상 출력 -->
	<select id="showLogerVideo" resultMap="VideoResultSet">
	SELECT RANK, AFILE_NM, V_NO, USER_NO, V_TITLE, COUNT, CH_NM, TAG, VBL_YN, UPLOAD_DT, MODIFY_DT, ADULT_AUT, AD_YN, AD_INFO, LOCATION, INFO, FILE_NM, OPEN_TY
		FROM (SELECT ROW_NUMBER() OVER(ORDER BY V.UPLOAD_DT DESC) RANK,	V.*, A.FILE_NM AFILE_NM
		FROM VIDEO V
		JOIN MEMBER M ON(V.USER_NO = M.USER_NO)
		JOIN ATTACHMENT A ON(V.V_NO = A.V_NO)
		WHERE V.USER_NO = #{userNo})
		ORDER BY RANK ASC
	
	</select>

	<!-- 정산페이지 조회 -->
	<select id="selectLogerCalculate" resultMap="calculateResultSet">
		SELECT RANK, CAL_NO, USER_NO, CH_NO, CAL_STDT, CAL_EDT, CAL_PRICE, CAL_VAT,
		AMOUNT_PRICE, CAL_TY, ACC_NM, BANK_NM, ACCOUNT
		FROM(SELECT ROW_NUMBER()
		OVER(ORDER BY C.CAL_STDT DESC) RANK, C.*
		FROM CALCULATE C
		JOIN MEMBER M
		ON(C.USER_NO = M.USER_NO)
		WHERE M.USER_ID = #{userId})
		ORDER BY RANK ASC
	</select>

	<select id="selectLogerSupport" resultMap="supportResultSet">
		SELECT RANK, NICKNAME, SUP_NO, USER_NO, CH_NO, SUP_STDT, SUP_PRICE, SUP_TY, CAL_STATUS
		FROM(SELECT ROW_NUMBER() OVER(ORDER BY S.SUP_STDT DESC) RANK,
		M.NICKNAME, S.*
		FROM SUPPORT S
        JOIN LOGER L ON(L.CH_NO = S.CH_NO)
		JOIN MEMBER M ON(S.USER_NO = M.USER_NO)
		WHERE S.CH_NO = #{chNo}
		AND M.USER_NO != #{userNo})
		ORDER BY RANK ASC
	</select>

	<!-- 로거 마지막 계좌 select -->
	<select id="logerLastAccount" resultMap="logerResultSet">
		SELECT *
		FROM LOGER L
		JOIN MEMBER M ON(L.USER_NO = M.USER_NO)
		WHERE M.USER_ID =
		#{userId}
	</select>

	<!-- 로거 기간별 후원 내역 조회 -->
	<select id="selectLogetSupportDate" resultMap="supportResultSet">
		SELECT RANK, NICKNAME, SUP_NO, USER_NO, CH_NO, SUP_STDT, SUP_PRICE, SUP_TY, CAL_STATUS
		FROM(SELECT ROW_NUMBER() OVER(ORDER BY S.SUP_STDT DESC) RANK,
		M.NICKNAME, S.*
		FROM SUPPORT S
        JOIN LOGER L ON(L.CH_NO = S.CH_NO)
		JOIN MEMBER M ON(S.USER_NO = M.USER_NO)
		WHERE S.CH_NO = #{chNo}
		AND M.USER_NO != #{userNo}
        AND CAL_STATUS = 0)
		WHERE SUP_STDT BETWEEN
		TO_CHAR(TO_DATE(#{mon},'YYYY-MM-DD')) AND
		TO_CHAR(TO_DATE(#{day},'YYYY-MM-DD'))
		<!-- AND RANK BETWEEN 1 AND 10 -->
		ORDER BY RANK ASC
	</select>

	<!-- 로거 계좌 update -->
	<update id="updateLogerAccount" parameterType="Loger">
		UPDATE LOGER SET ACC_NM = #{accNm}, BANK_NM = #{bankNm}, ACCOUNT =
		#{account}
		WHERE USER_NO = #{userNo}
	</update>

	<!-- 로거 기간별 후원 내역 조회의 값만 -->
	<select id="selectLogerSupportPrice"
		resultMap="supportResultSet">
		SELECT *
		FROM SUPPORT S
		JOIN MEMBER M ON(S.USER_NO = M.USER_NO)
		WHERE S.USER_NO = #{userNo}
		AND SUP_STDT BETWEEN TO_CHAR(TO_DATE(#{mon},'YYYY-MM-DD')) AND TO_CHAR(TO_DATE(#{day},'YYYY-MM-DD'))
  	</select>


	<!-- 로거 정보 -->
	<select id="selectLogerInfo" resultMap="logerResultSet">
		SELECT *
		FROM LOGER L
		JOIN
		MEMBER M ON(L.USER_NO = M.USER_NO)
		WHERE L.USER_NO = #{userNo}
	</select>

	<!-- 기간별 후원내역 검색 후 정산내역 insert -->
	<insert id="insertLogerCalculate" parameterType="Calculate">
		INSERT INTO
		CALCULATE
		VALUES(CAL_NO.NEXTVAL, #{userNo}, #{chNo}, SYSDATE, NULL,
		#{calPrice}, #{calVAT}, #{amountPrice},
		DEFAULT, #{accNm}, #{bankNm}, #{account})
	</insert>

	<!-- 후원내역 정산유무 update -->
	<update id="updateSupportCalculate" parameterType="Support">
		UPDATE SUPPORT SET CAL_STATUS = 1
        WHERE USER_NO = #{userNo}
      AND SUP_STDT BETWEEN TO_CHAR(TO_DATE(#{mon},'YYYY-MM-DD')) AND TO_CHAR(TO_DATE(#{day},'YYYY-MM-DD'))
   </update>
   
   
	 <delete id="videoDelete" parameterType="int">
	 	DELETE FROM VIDEO WHERE V_NO = #{vNo}
	 </delete>
	
	<delete id="attachmentDelete" parameterType="int">
	 	DELETE FROM ATTACHMENT WHERE V_NO = #{vNo}
	 </delete>
	
   

    <!-- 로거채널개설 insert 쿼리 -->
   <insert id="insertcreateChannel" parameterType="Loger">
      INSERT INTO LOGER
      VALUES (CH_NO.NEXTVAL, #{userNo}, #{chNm} , 0 , SYSDATE , #{chInfo}, Null,
      Null, Null, 0,0)

   </insert>


   <!--로거스튜디오 메인 select (프로필,채널명, 구독자) -->
   <select id="newHomeChannel" resultMap="logerResultSet2">
      SELECT l.ch_nm,l.subnum, a.file_nm ,l.ch_no
      FROM LOGER L
      JOIN ATTACHMENT A
      ON (L.USER_NO = A.USER_NO)
      WHERE a.am_ty ='회원'
      AND A.USER_NO = #{userNo}
   </select>

    <select id="reportlist" resultMap="ReportResultSet">
    SELECT RE_NO,V_TITLE,RE_WHY,RE_COUNT,FLOOR(C_COUNT/3)
 AS C_COUNT, RE_TY,R.CH_NM,RE_DT,A.FILE_NM,V.V_NO,V.COUNT,V.UPLOAD_DT
   FROM REPORT R
   JOIN VIDEO V ON (R.V_NO=V.V_NO)
   JOIN ATTACHMENT A ON(R.V_NO=A.V_NO)
   WHERE (RE_TY='동영상' OR  RE_TY='채널')
   AND R.RE_TARGET =#{userNo}  
    
   </select>  

  <!--
   <select id="reportlist" resultMap="ReportResultSet">
      SELECT *
      FROM REPORT R
      JOIN ATTACHMENT A ON(R.RE_TARGET=A.USER_NO)
      JOIN VIDEO V ON (A.USER_NO=V.USER_NO)
      WHERE R.RE_TARGET =#{userNo}

   </select> -->


   <select id="ccount" resultMap="Report2ResultSet">
      SELECT COUNT(R.RE_COUNT)
      FROM REPORT R
      WHERE RE_TARGET =#{userNo}
      AND RE_COUNT>=3
   </select>

   <select id="recount" resultMap="Report2ResultSet">
      SELECT SUM(R.RE_COUNT)
      FROM REPORT R
      WHERE RE_TARGET =#{userNo}
   </select>

   <update id="cstop" parameterType="Loger">
      UPDATE LOGER SET STATUS =1
      WHERE USER_NO=#{userNo}
   </update>

   
   <update id="cblockstatus" parameterType="Loger">
   UPDATE LOGER SET STATUS =1
   WHERE USER_NO=#{userNo}
   </update>
   <update id="vblockstatus" parameterType="Loger">
   UPDATE LOGER SET STATUS =1
   WHERE USER_NO=#{userNo}
   </update>
    
   <select id="reportcount " resultMap="ReportResultSet">
    SELECT  REP_NO,M.USER_NO,RE_COUNT,FLOOR(C_COUNT/3) AS C_COUNT, RE_TY 
     FROM REPORT R
     JOIN MEMBER M
     ON(M.USER_NO=R.RE_TARGET)
    WHERE (RE_TY='동영상' OR  RE_TY='채널')
     AND RE_TARGET=#{userNo}

	</select>
	
	<!-- 스튜디오 내  정보 -->
	<select id="logerHomeInfo"  parameterType="Loger"  resultMap="logerResultSet2">
    SELECT *
    FROM ATTACHMENT A
    JOIN LOGER L
    ON(A.USER_NO = L.USER_NO)
    WHERE AM_TY = '회원'
    AND  L.USER_NO = #{userNo}
	</select>
	
	
	<!-- 스튜디오 내  동영상 프로필 -->
	<select id="homeProfile"  parameterType="Loger"  resultMap="logerResultSet2">
    SELECT *
    FROM ATTACHMENT A
    JOIN LOGER L
    ON(A.USER_NO = L.USER_NO)
    WHERE AM_TY = '회원'
    AND  L.USER_NO = #{userNo}
	</select>

 <!-- 기존 구독자수 셀렉 -->
 <select id="resultSubnum" resultMap="logerResultSet">
	    
    SELECT SUBNUM
    FROM LOGER 
    WHERE USER_NO =  #{userNo}
	</select>
	
	<!-- 구독시 구독자수 증가 -->
	<update id="subBumUpdate" parameterType="Loger">
	UPDATE LOGER SET SUBNUM =  #{subNum}
    WHERE USER_NO =  #{chNo}
    
   </update>
   <!--로거스튜디오채널번호 받기 -->
 	<select id="selectChNo" resultMap="logerResultSet">
	SELECT CH_NO
	FROM LOGER
	WHERE USER_NO =  #{userNo}
	</select>
	
	
	<!-- 채널설명 업데이트 -->
	<update id="updateInfo"  parameterType="Loger">
	UPDATE LOGER SET CH_INFO = #{chInfo}
    WHERE USER_NO = #{userNo}
   </update>
 
	<!-- 구독시 값 가지고 오는 셀렉트 -->
	<select id="subUserInfo"  resultMap="SubUserInfoResultSet">
		SELECT L.CH_NO, M.NICKNAME , L.CH_NM 
	FROM LOGER L
	JOIN MEMBER M
	ON (L.USER_NO = M.USER_NO)
	WHERE  L.USER_NO = #{userNo}
	</select>


 <!-- 채널명 -->
	<select id="logerTitleNm"  resultMap="logerResultSet">
	SELECT CH_NM
	FROM LOGER
	WHERE USER_NO  = #{userNo}
	</select>
</mapper>



















